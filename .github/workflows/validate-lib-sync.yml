name: Validate lib/ Sync

# Runs on:
# - Every push to main
# - Every pull request
# - Before any release
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_call: # Can be called from other workflows

jobs:
  validate-sync:
    name: Validate src/ and lib/ are in sync
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run TypeScript compilation
        run: npx tsc

      - name: Check for differences between compiled lib/ and committed lib/
        run: |
          # Check if there are any differences
          if ! git diff --quiet lib/; then
            echo "‚ùå ERROR: lib/ folder is out of sync with src/"
            echo ""
            echo "The following files have differences:"
            git diff --name-only lib/
            echo ""
            echo "üìã Diff details:"
            git diff lib/
            echo ""
            echo "‚ö†Ô∏è  SOLUTION: Run 'npm run build:tsc' and commit the changes to lib/"
            exit 1
          else
            echo "‚úÖ lib/ folder is in sync with src/"
          fi

      - name: Verify retry-utils files exist
        run: |
          if [ ! -f "lib/Utils/retry-utils.js" ]; then
            echo "‚ùå ERROR: lib/Utils/retry-utils.js is missing"
            exit 1
          fi
          if [ ! -f "lib/Utils/retry-utils.d.ts" ]; then
            echo "‚ùå ERROR: lib/Utils/retry-utils.d.ts is missing"
            exit 1
          fi
          echo "‚úÖ All required lib/ files exist"

      - name: Type-check only (no emit)
        run: npx tsc --noEmit

      - name: Summary
        if: success()
        run: |
          echo "‚úÖ All validations passed!"
          echo "‚úÖ lib/ is in sync with src/"
          echo "‚úÖ TypeScript compilation successful"
          echo "‚úÖ Type-checking passed"
